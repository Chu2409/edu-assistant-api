generator client {
  provider     = "prisma-client"
  output       = "../src/core/database/generated"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

model User {
  id             Int       @id @default(autoincrement())
  email          String    @unique
  role           Role      @default(STUDENT)
  name           String    @map("name") // Nombre completo desde Microsoft
  lastName       String    @map("last_name") // Apellido completo desde Microsoft
  isActive       Boolean   @default(true) @map("is_active")
  microsoftId    String    @unique @map("microsoft_id") // ID único de Microsoft
  displayName    String    @map("display_name") // Nombre completo desde Microsoft
  profilePicture String?   @map("profile_picture") // URL de foto de perfil (opcional)
  lastLoginAt    DateTime? @map("last_login_at") // Última vez que inició sesión
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  modulesAsTeacher Module[]          @relation("TeacherModules")
  enrollments      Enrollment[]
  generatedContent Note[]
  activityAttempts ActivityAttempt[]
  notifications    Notification[]
  pageFeedbacks    PageFeedback[]
  promptFeedbacks  Prompt[]
  studentQuestions StudentQuestion[]
  questionReplies  QuestionReply[]
  pageViews        PageView[]
  sessions         Session[]

  @@index([microsoftId])
  @@map("users")
}

// ============================================
// MODULES (COURSES)
// ============================================

model Module {
  id                Int      @id @default(autoincrement())
  title             String
  description       String?  @db.Text
  teacherId         Int      @map("teacher_id")
  isPublic          Boolean  @default(false) @map("is_public")
  allowSelfEnroll   Boolean  @default(true) @map("allow_self_enroll")
  allowSelfUnenroll Boolean  @default(true) @map("allow_self_unenroll")
  logoUrl           String?  @map("logo_url")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  teacher         User             @relation("TeacherModules", fields: [teacherId], references: [id], onDelete: Cascade)
  pages           Page[]
  enrollments     Enrollment[]
  aiConfiguration AiConfiguration?
  moduleMetrics   ModuleMetrics?

  @@index([teacherId])
  @@map("modules")
}

// ============================================
// AI CONFIGURATION (RF-9, RF-10)
// ============================================

enum AiTargetLevel {
  BASIC
  INTERMEDIATE
  ADVANCED
}

enum AiAudience {
  HIGH_SCHOOL
  UNIVERSITY
  PROFESSIONAL
}

enum AiLength {
  SHORT
  MEDIUM
  LONG
}

enum AiCodePolicy {
  NONE
  EXERCISES
  EXAMPLES
}

enum AiTone {
  FORMAL
  EDUCATIONAL
  CASUAL
}

model AiConfiguration {
  id                 Int           @id @default(autoincrement())
  moduleId           Int           @unique @map("module_id")
  language           String        @default("es") // RF-9: idioma específico
  contextPrompt      String?       @map("context_prompt") // RF-10: contexto personalizado del módulo
  targetLevel        AiTargetLevel @default(INTERMEDIATE) @map("target_level")
  audience           AiAudience    @default(UNIVERSITY) @map("audience")
  learningObjectives String[]      @map("learning_objectives")
  contentLength      AiLength      @default(MEDIUM) @map("content_length")
  codePolicy         AiCodePolicy  @default(EXAMPLES) @map("code_policty")
  tone               AiTone        @default(EDUCATIONAL) @map("tone")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@map("ai_configurations")
}

// ============================================
// ENROLLMENTS (RF-1)
// ============================================

model Enrollment {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  moduleId    Int       @map("module_id")
  enrolledAt  DateTime  @default(now()) @map("enrolled_at")
  completedAt DateTime? @map("completed_at")
  isActive    Boolean   @default(true) @map("is_active")

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@index([userId])
  @@index([moduleId])
  @@map("enrollments")
}

// ============================================
// PAGES
// ============================================

model Page {
  id                Int                          @id @default(autoincrement())
  moduleId          Int                          @map("module_id")
  title             String
  orderIndex        Int                          @map("order_index")
  embedding         Unsupported("vector(1536)")?
  keywords          String[] // Mantener para búsquedas
  isPublished       Boolean                      @default(false) @map("is_published")
  lastProcessedAt   DateTime?                    @map("last_processed_at") // Cuándo se procesó el HTML
  processingVersion Int                          @default(1) @map("processing_version") // Para re-procesar si cambias lógica
  createdAt         DateTime                     @default(now()) @map("created_at")
  updatedAt         DateTime                     @updatedAt @map("updated_at")

  module           Module            @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  activities       Activity[]
  relatedPagesFrom PageRelation[]    @relation("OriginPage")
  relatedPagesTo   PageRelation[]    @relation("RelatedPage")
  conceptMentions  PageConcept[]
  notes            Note[]
  podcasts         Podcast[]
  mediaResources   MediaResource[]
  pageFeedbacks    PageFeedback[]
  promptFeedbacks  Prompt[]
  studentQuestions StudentQuestion[]
  pageViews        PageView[]
  sessions         Session[]
  blocks           Block[]

  @@unique([moduleId, orderIndex])
  @@index([moduleId])
  @@index([lastProcessedAt]) // NEW: para batch que actualiza HTMLs viejos
  @@map("pages")
}

enum BlockType {
  TEXT
  CODE
  IMAGE
  IMAGE_SUGGESTION
}

model Block {
  id        Int       @id @default(autoincrement())
  pageId    Int       @map("page_id")
  type      BlockType @map("type")
  content   Json      @map("content")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@map("blocks")
}

model Session {
  id        Int      @id @default(autoincrement())
  title     String   @map("title")
  startedAt DateTime @default(now()) @map("started_at")
  userId    Int      @map("user_id")
  pageId    Int      @map("page_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, map: "sessions_user_id_fkey")
  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade, map: "sessions_page_id_fkey")

  messages Message[]

  @@unique([userId, pageId])
  @@map("sessions")
}

enum MessageRole {
  user
  assistant
  developer
  tool
  system
}

model Message {
  id        Int         @id @default(autoincrement())
  content   String      @map("content")
  metadata  String?     @map("metadata")
  role      MessageRole @map("role")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  sessionId Int
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("messages")
}

// ============================================
// PAGE VIEWS (Control de visualización de estudiantes)
// ============================================

model PageView {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  pageId        Int      @map("page_id")
  firstViewedAt DateTime @default(now()) @map("first_viewed_at")
  lastViewedAt  DateTime @updatedAt @map("last_viewed_at")
  viewCount     Int      @default(1) @map("view_count") // número de veces que ha visto la página
  timeSpent     Int      @default(0) @map("time_spent") // tiempo total en segundos
  isCompleted   Boolean  @default(false) @map("is_completed") // si completó la visualización
  progress      Float    @default(0) // porcentaje de progreso (0-100)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([userId, pageId])
  @@index([userId])
  @@index([pageId])
  @@index([isCompleted])
  @@map("page_views")
}

// ============================================
// PAGE RELATIONS (RF-6: contenidos relacionados)
// ============================================

enum RelationType {
  SEMANTIC // similitud semántica
  PREREQUISITE // prerequisito recomendado
  COMPLEMENTARY // contenido complementario
  DEEPENING // profundización del tema
  APPLIED_EXAMPLE // ejemplo aplicado
}

model PageRelation {
  id              Int          @id @default(autoincrement())
  originPageId    Int          @map("origin_page_id")
  relatedPageId   Int          @map("related_page_id")
  similarityScore Float        @map("similarity_score")
  relationType    RelationType @map("relation_type")
  mentionText     String       @map("mention_text") // Texto exacto enlazado: "respiración celular"
  explanation     String?      @db.Text
  isEmbedded      Boolean      @default(false) @map("is_embedded") // Ya está en el HTML?
  embeddedAt      DateTime?    @map("embedded_at") // Cuándo se incrustó
  calculatedAt    DateTime     @default(now()) @map("calculated_at")
  createdAt       DateTime     @default(now()) @map("created_at")

  originPage  Page @relation("OriginPage", fields: [originPageId], references: [id], onDelete: Cascade)
  relatedPage Page @relation("RelatedPage", fields: [relatedPageId], references: [id], onDelete: Cascade)

  @@unique([originPageId, relatedPageId])
  @@index([originPageId])
  @@index([relatedPageId])
  @@index([isEmbedded]) // NEW: filtrar las que faltan incrustar
  @@map("page_relations")
}

// ============================================
// MODULE CONCEPTS (RF-7)
// ============================================
model PageConcept {
  id         Int      @id @default(autoincrement())
  pageId     Int      @map("page_id")
  term       String
  definition String   @db.Text
  htmlId     String   @map("html_id") // id único en el HTML: "concept-c123"
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, term])
  @@index([pageId])
  @@index([htmlId]) // NEW: buscar por ID en HTML
  @@map("page_concepts")
}

// ============================================
// ACTIVITIES/REACTIVOS (RF-8)
// ============================================

enum ActivityType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  FILL_BLANK
  MATCH
}

model Activity {
  id                  Int          @id @default(autoincrement())
  pageId              Int          @map("page_id")
  type                ActivityType
  question            String       @db.Text
  options             Json? // para multiple choice, matching, etc.
  correctAnswer       Json         @map("correct_answer")
  explanation         String?      @db.Text
  difficulty          Int          @default(1) // 1-5
  orderIndex          Int          @map("order_index")
  isApprovedByTeacher Boolean      @default(false) @map("is_approved_by_teacher") // RF-8: aprobado por docente
  usedAsExample       Boolean      @default(false) @map("used_as_example") // RF-8a: usado para generar más
  generatedFromId     Int?         @map("generated_from_id") // RF-8a: generado a partir de otro
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  // Relations
  page                Page              @relation(fields: [pageId], references: [id], onDelete: Cascade)
  generatedFrom       Activity?         @relation("GeneratedActivities", fields: [generatedFromId], references: [id], onDelete: SetNull)
  generatedActivities Activity[]        @relation("GeneratedActivities")
  attempts            ActivityAttempt[]

  @@index([pageId])
  @@index([isApprovedByTeacher])
  @@index([usedAsExample])
  @@map("activities")
}

// ============================================
// ACTIVITY ATTEMPTS
// ============================================

model ActivityAttempt {
  id            Int      @id @default(autoincrement())
  activityId    Int      @map("activity_id")
  userId        Int      @map("user_id")
  studentAnswer Json     @map("student_answer")
  isCorrect     Boolean  @map("is_correct")
  attemptNumber Int      @map("attempt_number") // número de intento
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([activityId])
  @@index([userId])
  @@index([isCorrect])
  @@map("activity_attempts")
}

// ============================================
// GENERATED CONTENT (RF-4, RF-5)
// ============================================
model Prompt {
  id        Int      @id @default(autoincrement())
  pageId    Int?     @map("page_id")
  userId    Int      @map("user_id") // quien solicitó la generación
  prompt    String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  page Page? @relation(fields: [pageId], references: [id], onDelete: Cascade)
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([userId])
  @@map("prompts")
}

model PageFeedback {
  id     Int  @id @default(autoincrement())
  pageId Int? @map("page_id")
  userId Int  @map("user_id") // quien solicitó la generación

  feedback  String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  page Page? @relation(fields: [pageId], references: [id], onDelete: Cascade)
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([userId])
  @@map("page_feedback")
}

enum ContentType {
  PAGE_CONTENT // contenido de lección generado @map("PAGE_CONTENT")
  EXPLANATION // explicación a estudiante
  SUMMARY // resumen
  QUIZ // reactivo generado
  PODCAST_SCRIPT // script para podcast
  REFINEMENT // refinamiento de contenido
  RELATED_CONTENT // contenido relacionado sugerido
}

model Note {
  id        Int      @id @default(autoincrement())
  pageId    Int?     @map("page_id")
  userId    Int      @map("user_id") // quien solicitó la generación
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  page Page? @relation(fields: [pageId], references: [id], onDelete: Cascade)
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([userId])
  @@map("notes")
}

// ============================================
// STUDENT QUESTIONS (RF-12, RF-14)
// ============================================

model StudentQuestion {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  pageId    Int      @map("page_id")
  question  String   @map("question") @db.Text
  isPublic  Boolean  @default(true) @map("is_public") // visible en foro
  upvotes   Int      @default(0) // para priorizar en foro
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  page    Page            @relation(fields: [pageId], references: [id], onDelete: Cascade)
  replies QuestionReply[]

  @@index([userId])
  @@index([pageId])
  @@index([isPublic])
  @@map("student_questions")
}

model QuestionReply {
  id            Int      @id @default(autoincrement())
  questionId    Int      @map("question_id")
  userId        Int      @map("user_id")
  replyText     String   @map("reply_text") @db.Text
  isFromTeacher Boolean  @default(false) @map("is_from_teacher")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  question StudentQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user     User            @relation(fields: [userId], references: [id])

  @@index([questionId])
  @@map("question_replies")
}

// ============================================
// NOTIFICATIONS (RF-13)
// ============================================

enum NotificationType {
  NEW_PAGE
  PAGE_UPDATE
  CONCEPT_ADDED
  SUGGESTED_CONTENT
  QUESTION_ANSWERED
  TEACHER_REPLY
  EXCESSIVE_USE_WARNING // RF-13: abuso de herramienta
  MODULE_UPDATE
}

model Notification {
  id                Int              @id @default(autoincrement())
  userId            Int              @map("user_id")
  type              NotificationType
  title             String
  message           String           @db.Text
  relatedEntityId   Int?             @map("related_entity_id") // ID de lección, pregunta, etc.
  relatedEntityType String?          @map("related_entity_type")
  isRead            Boolean          @default(false) @map("is_read")
  emailSent         Boolean          @default(false) @map("email_sent")
  createdAt         DateTime         @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================
// PODCASTS (RF-15)
// ============================================

model Podcast {
  id            Int      @id @default(autoincrement())
  pageId        Int?     @map("page_id")
  title         String
  description   String?  @db.Text
  audioUrl      String   @map("audio_url") // URL externa (S3, Cloudinary, etc.)
  duration      Int? // duración en segundos
  scriptContent String?  @map("script_content") @db.Text // guión generado
  isPublished   Boolean  @default(false) @map("is_published")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  page Page? @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@map("podcasts")
}

// ============================================
// MEDIA RESOURCES (videos, imágenes, archivos)
// ============================================

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  OTHER
}

model MediaResource {
  id           Int       @id @default(autoincrement())
  pageId       Int?      @map("page_id")
  type         MediaType
  title        String?
  url          String // URL externa
  thumbnailUrl String?   @map("thumbnail_url")
  fileSize     Int?      @map("file_size") // bytes
  mimeType     String?   @map("mime_type")
  createdAt    DateTime  @default(now()) @map("created_at")

  // Relations
  page Page? @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([type])
  @@map("media_resources")
}

// ============================================
// MODULE METRICS (RF-11: analytics para docente)
// ============================================

model ModuleMetrics {
  id                    Int      @id @default(autoincrement())
  moduleId              Int      @unique @map("module_id")
  totalViews            Int      @default(0) @map("total_views")
  totalStudents         Int      @default(0) @map("total_students")
  averageCompletionRate Float    @default(0) @map("average_completion_rate")
  mostViewedPageId      Int?     @map("most_viewed_page_id")
  lastCalculatedAt      DateTime @default(now()) @map("last_calculated_at")

  // Relations
  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@map("module_metrics")
}
